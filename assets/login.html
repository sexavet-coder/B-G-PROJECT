<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login | E-commerce</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>

  <!-- common navbar -->
  <div class="bg-primary text-white text-center py-2">
    Summer Sale For All Swim Suits And Free Express Delivery - OFF 50%!
    <a href="#" class="text-white text-decoration-underline">Shop Now</a>
  </div>

  <nav class="navbar navbar-expand-lg bg-light border-bottom">
    <div class="container">
      <a class="navbar-brand" href="index.html">E-commerce</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="shop.html">Shop</a></li>
          <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
          <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
        </ul>
        <div class="d-flex align-items-center">
          <a id="cartLink" class="me-3" href="cart.html"><i class="bi bi-cart"></i></a>
          <a id="loginBtn" class="btn btn-light btn-sm me-2" href="login.html">Log in</a>
          <a id="logoutBtn" class="btn btn-danger btn-sm" href="#" style="display:none;">Log out</a>
          <span id="usernameDisplay" class="ms-2 fw-bold"></span>
        </div>
      </div>
    </div>
  </nav>

  <div class="container py-5" style="max-width:400px;">
    <h3 class="text-center mb-4">Log In</h3>
    <div class="card p-4 shadow-sm">
      <div class="mb-3">
        <label class="form-label">Username</label>
        <input type="text" id="loginUsername" class="form-control" placeholder="Enter your username">
      </div>
      <div class="mb-3">
        <label class="form-label">Password</label>
        <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password">
      </div>
      <button class="btn btn-primary w-100" id="doLogin">Log In</button>
      <p class="mt-3 text-center small">Don't have an account? <a href="signup.html">Sign up</a></p>
    </div>
  </div>

  <footer class="mt-5 text-white bg-dark">
    <div class="container py-5">
      <!-- footer same as your original -->
      <div class="text-center py-3 border-top border-light">
        <small>Â© Copyright Rimel 2022. All rights reserved.</small>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- global helpers -->
  <script src="./script.js"></script>

  <script>
    // ensure navbar reflects login state
    window.initNavbar && initNavbar();

    document.getElementById("doLogin").addEventListener("click", async () => {
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value.trim();

      if (!username || !password) {
        alert("Please fill in all fields!");
        return;
      }

      try {
        const response = await fetch("http://195.26.245.5:9505/api/auth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (!response.ok) {
          // try to show message from API
          throw new Error(data?.message || "Invalid credentials");
        }

        // NOTE: try a few common response shapes (defensive)
        // Prefer data.body.token and data.body.username if present, otherwise data.token/data.username
        let tokenValue = null;
        let usernameValue = "";

        if (data?.body?.token) {
          tokenValue = data.body.token;
          usernameValue = data.body.username || username;
        } else if (data?.token) {
          tokenValue = data.token;
          usernameValue = data.username || username;
        } else if (data?.accessToken) {
          tokenValue = data.accessToken;
          usernameValue = data.username || username;
        }

        if (!tokenValue) {
          throw new Error("Login succeeded but token not found in response.");
        }

        // Store as JSON object so all pages can parse uniformly
        localStorage.setItem("token", JSON.stringify({
          token: tokenValue,
          username: usernameValue
        }));

        alert("Login successful!");
        window.location.href = "index.html";
      } catch (err) {
        console.error("Login error:", err);
        alert("Error: " + err.message);
      }
    });
  </script>
</body>
</html>